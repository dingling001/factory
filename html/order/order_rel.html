<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>发布订单</title>
    <script src="../../assets/js/fontsize.js"></script>
    <link rel="stylesheet" href="../../assets/css/api.css">
    <link rel="stylesheet" href="../../assets/css/style.css">
    <!--<link rel="stylesheet" href="https://unpkg.com/mint-ui@1/lib/style.css">-->
    <link rel="stylesheet" href="../../assets/font/iconfont.css">
    <style type="text/css">

        .input_box {
            margin: 0;
            padding: .3rem .25rem .3rem .4rem;
            background-color: #fff;
        }

        .label {
            font-size: 16px;
            position: relative;
            color: #333;
        }

        .need::before {
            position: absolute;
            right: -7px;
            top: 2px;
            text-align: center;
            transform: translateY(-50%);
            content: '*';
            padding-top: 5px;
            color: #E32A2A;
            font-weight: bold;
            font-size: 15px;
            /*px*/
        }

        .company .infoinput {
            text-align: right;
            font-size: 13px;
            flex: 1;
            padding: 0 .25rem;
            color: #666;
        }

        .type .infoinput {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .type .infoinput span {
            padding: .1rem .15rem;
            background-color: #E72424;
            border-radius: 5px;
            color: #ffff;
            margin-left: .2rem;
        }

        .infoinput .num {
            color: #E51F1F;
        }

        .company .border-t {
            border-top: 1px solid #EEEEEE;
        }

        .company .border-0 {
            border: 0;
        }

        .area_box {
            font-size: 16px;
            width: 85%;
            height: 2.9rem;
            margin: 0 auto;
            border: 1px solid #D2D2D2;
            border-radius: 5px;
        }

        .area_box textarea {
            resize: none;
            width: 100%;
            height: 100%;
            border: 0;
            text-decoration: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            outline: none;
            padding: 0.22rem;
        }

        .area_box textarea::placeholder {
            color: #999999;
            font-size: 14px;
        }

        .title {
            border: 0;
        }

        .title .label {
            font-weight: bold;
        }

        .detail_title {
            background-color: #fff;
            padding: .3rem .45rem;
            font-size: 15px;
            font-weight: bold;
            margin-top: .36rem;
        }

        .pic_list {
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            padding: 0 .24rem;
            background-color: #fff;
        }

        .pic_item {
            width: 31.5%;
            margin: 0 2.6% .2rem 0;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 1.65rem;
            border-radius: 3px;
            position: relative;
        }

        .add {
            background-color: #E4E4E4;
        }

        .pic_item:nth-child(3n) {
            margin: 0 0 .2rem 0;
        }

        .pic_item img {
            height: 100%;
        }

        .pic_item .iconfont {
            color: #CECECE;
            font-size: 25px;
        }

        .pic_item .del {
            position: absolute;
            right: -.1rem;
            top: -.1rem;
            z-index: 10;
            font-size: 0;
            width: .5rem;
            height: .5rem;
            text-align: center;
            line-height: .5rem;
            border-radius: 50%;
            background-color: rgba(0, 0, 0, .1);
        }

        .pic_item .del .iconfont {
            font-size: 14px;
            color: #E51F1F;

        }

        .d_file {
            /*display: flex;*/
            /*align-items: center;*/
            /*justify-content: space-between;*/
            /*padding: .5rem 0;*/
            background-color: #fff;
            /*margin-bottom: .36rem;*/
            text-align: center;
            font-size: 13px;
            padding: 0.1rem 0 .4rem 0;
        }

        .d_file .a {
            color: #73B5FF;
            font-size: 13px;
        }

        .d_left {
            font-size: 15px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            font-weight: bold;
        }

        .d_img {
            width: .7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: .22rem;
        }

        .d_img img {
            width: 100%;
        }

        .input_box .notice {
            font-size: 10px;
            color: #999;
        }

        .tips {
            font-size: 11px;
            color: #999;
            padding: 0 .4rem;
            background-color: #fff;
        }

        .tips span {
            color: #E51F1F;
            font-size: 14px;
        }

        .vip_box {
            padding: 1rem 0 2rem 0;
            background-color: #fff;
        }

        .vip_box .vip_btn {
            width: 45%;
            text-align: center;
            padding: .2rem 0;
            font-size: 15px;
            color: #fff;
            background-color: #E72424;
            box-shadow: 0 6px 7px 0 rgba(231, 36, 36, 0.13);
            border-radius: 5px;
            margin: 0 auto;
        }

        .company input {
            text-align: right;
            width: 100%;
            padding: 0;
        }

        .infoselect {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            font-size: 16px;
            color: #999;
        }

        .infoselect .iconfont {
            font-size: 18px;
            color: #CECED1;
        }

        .infoselect .is-selected {
            color: #333;
        }

        ul {
            padding: 0;
            list-style: none;
            display: flex;
            align-items: center;
            /*justify-content: flex-end;*/
            /*justify-content: space-between;*/
            flex-wrap: wrap;
        }

        li {
            height: 30px;
            text-align: center;
            line-height: 30px;
            cursor: pointer;
            margin-right: .2rem;
            font-size: 13px;
            display: flex;
            align-items: center;
            -webkit-transition: ease-in-out .3s;
            -moz-transition: ease-in-out .3s;
            -ms-transition: ease-in-out .3s;
            -o-transition: ease-in-out .3s;
            transition: ease-in-out .3s;
        }

        li.typeactive {
            color: #E72424;
        }

        li .iconfont {
            margin-right: .1rem;
            font-size: 13px;
        }

        li.icon-xuzhong1 {
            color: #E72424;
        }
    </style>
</head>
<body>
<div id="app" v-cloak class="company">
    <div class="input_box title">
        <span class="label ">发布订单</span>
        <!--<div class="infoinput">发布日期：{{d_info.create_time}}</div>-->
    </div>
    <div class="hr"></div>
    <form>
        <div class="input_box">
            <span class="label">标题</span>
            <div class="infoinput"><input type="text" placeholder="请输入订单标题" v-model="postData.title"></div>
        </div>
        <div class="input_box" @click="openCity">
            <span class="label">地区</span>
            <div class="infoinput">
                <div class="infoselect">
                    <span v-if="province&&city&&district" class="is-selected">{{province}}-{{city}}-{{district}}</span>
                    <span v-else>请完善地区</span>
                    <span class="iconfont icon-arrow-right"></span>
                </div>
            </div>
        </div>
        <div class="input_box">
            <span class="label">类型</span>
            <div class="infoinput">
                <ul>
                    <li v-for="(c,index) in cate_list" :key="c.id" @click="checkedBox(c.id)"
                        :class="{'typeactive':postData.cate_ids.includes(c.id)}">
                        <span :class="['iconfont',postData.cate_ids.includes(c.id)?'icon-xuanzhong':'icon-xuanzhong1']"></span>{{c.cate_name}}
                    </li>
                </ul>
            </div>
        </div>
        <div class="input_box ">
            <span class="label">材质</span>
            <div class="infoinput"><input type="text" placeholder="请输入商品材质信息" v-model="postData.material"></div>
        </div>
        <div class="input_box">
            <span class="label">数量</span>
            <div class="infoinput"><input type="number" v-model="postData.num" placeholder="请输入数量"></div>
        </div>
        <div class="input_box">
            <span class="label">单位</span>
            <div class="infoinput"><input type="text" maxlength="5" v-model="postData.unit" placeholder="请输入单位（件）"></div>
        </div>
        <div class="input_box " @click="openDate">
            <span class="label">订单截止日期</span>
            <div class="infoinput">
                <div class="infoselect">
                    <span v-if="postData.end_time" class="is-selected">{{postData.end_time}}</span>
                    <span v-else>请选择订单失效时间</span>
                    <span class="iconfont icon-arrow-right"></span>
                </div>
            </div>
        </div>
        <div class="input_box border-0">
            <span class="label">订单备注：</span>
        </div>
        <div class="area_box">
            <textarea v-model="postData.desc" placeholder="请输入订单备注（不超过200字）" maxlength="200"></textarea>
        </div>
        <div class="detail_title">相关图片</div>
        <div class="pic_list">
            <div class="pic_item" v-for="(item,index) in postData.pic_url" v-if="postData.pic_url.length>0"
                 @click="browserImg(index)">
                <img :src="item?imgUrl+item:'../../asset/image/load.gif'" alt="">
                <div class="close_left del" @click.stop="delImg(index)">
                    <span class="iconfont icon-shanchushu"></span>
                </div>
            </div>
            <div class="pic_item add" v-if="postData.pic_url.length<9" @click="addImg"><span
                    class="iconfont icon-hao"></span>
            </div>
        </div>
        <div class="detail_title">订单附件</div>
        <div class="d_file" @click="callMe">
            <span class="a">如需上传附件，请联系平台管理员：{{telNumber}}</span>
        </div>
        <div class="input_box">
            <span class="label">会员信息 <span class="notice">注：此处信息需开通会员后可查看</span></span>
        </div>
        <div class="input_box">
            <span class="label">发单企业</span>
            <div class="infoinput"><input type="text" placeholder="请输入公司名称" v-model="postData.compname"></div>
        </div>
        <div class="input_box">
            <span class="label">联系方式</span>
            <div class="infoinput"><input type="number" v-model="postData.linktel" placeholder="请输入公司联系人电话"></div>
        </div>
        <div class="input_box">
            <span class="label">负责人</span>
            <div class="infoinput"><input type="text" v-model="postData.linkman" placeholder="请输入公司联系人姓名"></div>
        </div>
        <div class="vip_box">
            <div class="vip_btn" @click="relOrder">立即发布</div>
        </div>
    </form>
</div>
</body>
</html>
<script type="text/javascript" src="../../assets/js/api.js"></script>
<script type="text/javascript" src="../../assets/js/fastclick.js"></script>
<script>
    new FastClick(document.body);
</script>
<script type="text/javascript" src="../../assets/js/vue.min.js"></script>
<script type="text/javascript" src="../../assets/js/index.js"></script>
<script type="text/javascript" src="../../assets/js/public.js"></script>
<script type="text/javascript" src="../../assets/js/res.js"></script>
<script>
    var app = new Vue({
        el: '#app',
        data: {
            province: '',
            city: '',
            district: '',
            province_code: '',
            city_code: '',
            region_code: '',
            cate_list: [],
            arr: [],
            telNumber: '022-84378477',
            postData: {
                title: '',
                province_code: '',
                city_code: '',
                region_code: '',
                cate_ids: [],
                material: '',
                num: '',
                unit:'',
                end_time: '',
                desc: '',
                pic_url: [],
                compname: '',
                linktel: '',
                linkman: '',
                uploadtime: 0
            }
        },
        created: function () {
            apiready = function () {
                app._getCateList();
                // 城市选择监听
                api.addEventListener({
                    name: 'city_event'
                }, function (ret, err) {
                    if (ret) {
                        app.province = ret.value.province;
                        app.city = ret.value.city;
                        app.district = ret.value.district;
                        app.postData.province_code = ret.value.province_code;
                        app.postData.city_code = ret.value.city_code;
                        app.postData.region_code = ret.value.region_code;
                    }
                });
                // if ($api.getStorage('postData')) {
                //     app.postData = JSON.parse($api.getStorage('postData'))
                // }
            }
        },
        methods: {
            // 获取分类列表getCateList
            _getCateList: function () {
                ApiAjax('api/getAllCateList', {}, function (ret, err) {
                    app.cate_list = ret.data.list;
                })
            },
            // 类型多选
            checkedBox: function (i) {
                const contains = (function () {
                    return Array.prototype.includes
                        ? function (arr, value) {
                            return arr.includes(value)
                        }
                        : function (arr, value) {
                            arr.some(function (el) {
                                return el === value
                            })
                        }
                })();
                if (contains(app.postData.cate_ids, i)) {
                    //includes()方法判断是否包含某一元素,返回true或false表示是否包含元素，对NaN一样有效
                    //filter()方法用于把Array的某些元素过滤掉，filter()把传入的函数依次作用于每个元素，然后根据返回值是true还是false决定保留还是丢弃该元素：生成新的数组
                    app.postData.cate_ids = app.postData.cate_ids.filter(function (ele) {
                        return ele != i;
                    });
                    //this.arr=this.arr.filter((ele)=>ele!=i);
                    //filter()为假时删除
                } else {
                    app.postData.cate_ids.push(i);
                }
            },
            // 打开城市选择
            openCity: function () {
                api.openFrame({
                    name: 'city',
                    url: '../common/city.html',
                    rect: {
                        x: 0,
                        y: 0,
                        w: 'auto',
                        h: 'auto'
                    },
                    animation: {
                        type: "none",                //动画类型（详见动画类型常量）
                        subType: "from_bottom",       //动画子类型（详见动画子类型常量）
                        duration: 1000                //动画过渡时间，默认300毫秒
                    },
                    reload: true,
                    bounces: false,
                    bgColor: 'rgba(0,0,0,0.6)',
                });
            },
            // 订单最终时间
            openDate: function () {
                api.openPicker({
                    type: 'date',
                    title: '订单截止日期',
                    minDate: new Date()
                }, function (ret, err) {
                    if (ret) {
                        var year = ret.year;
                        var month = ret.month;
                        var day = ret.day;
                        app.postData.end_time = year + '-' + add0(month) + '-' + add0(day);
                        if (checkDate(app.postData.end_time, 2)) {
                            return app.postData.end_time
                        } else {
                            toastMsg('订单有效时间不能比今天晚');
                            return app.postData.end_time = ''
                        }
                    } else {
                    }
                });
            },
            // 拨打管理员电话
            callMe: function () {
                api.call({
                    type: 'tel_prompt',
                    number: app.telNumber
                });
            },
            // 添加图片
            addImg: function () {
                var resultList = api.hasPermission({
                    list: ['storage', 'camera']
                });
                var hasThisPerm = JSON.stringify(resultList[0].granted);
                var hasThiscamera = JSON.stringify(resultList[1].granted);
                if (hasThisPerm == "true" && hasThiscamera == "true") {
                    app.actionsheet();
                } else {
                    //如果还没有获取存储权限，则动态获取
                    api.requestPermission({
                        list: ['storage', 'camera']
                    }, function (ret, err) {
                        //权限选择结果，安卓机一般是：禁止、始终允许、不再提醒
                        var selected = JSON.stringify(ret.list[0].granted);
                        var selecteds = JSON.stringify(ret.list[1].granted);
                        //如果选择始终允许，则返回true
                        if (selected && selecteds) {
                            //业务处理，直接打开本地存储图片
                            app.actionsheet()
                        } else {
                            toastMsg('请开启权限发布订单')
                        }
                    })
                }
            },
            // 弹层选择
            actionsheet: function () {
                api.actionSheet({
                    title: '上传相关图片',
                    cancelTitle: '取消',
                    destructiveTitle: '',
                    buttons: ['拍照', '图片库', '从手机相册选择'],
                    style: {
                        layerColor: 'rgba(0, 0, 0, 0.6)',         //遮蔽层颜色，仅支持 rgba颜色，默认值：rgba（0, 0, 0, 0.4）
                        itemNormalColor: '#F1F1F1',    //选项按钮正常状态背景颜色，支持#000、#000000、rgb、rgba，默认值：#F1F1F1
                        itemPressColor: '#E6E6E6',     //选项按钮按下时背景颜色，支持#000、#000000、rgb、rgba，默认值：#E6E6E6
                        fontNormalColor: '#007AFF',    //选项按钮正常状态文字颜色，支持#000、#000000、rgb、rgba，默认值：#007AFF
                        fontPressColor: '#0060F0',     //选项按钮按下时文字颜色，支持#000、#000000、rgb、rgba，默认值：#0060F0
                        titleFontColor: '#8F8F8F'      //标题文字颜色，支持#000、#000000、rgb、rgba，默认值：#8F8F8F
                    }
                }, function (ret, err) {
                    var index = ret.buttonIndex;
                    switch (index) {
                        case 1:
                            app.getPicture('camera');
                            break;
                        case 2:
                            app.getPicture('library');
                            break;
                        case 3:
                            app.getPicture('album');
                            break;
                        default:
                            return
                    }
                });
            },
            // 选择图片
            getPicture: function (sourceType) {
                api.getPicture({
                    sourceType: sourceType,
                    encodingType: 'jpg',
                    mediaValue: 'pic',
                    destinationType: 'url',
                    allowEdit: true,
                    quality: 100,
                    saveToPhotoAlbum: true,
                    groupName: 'jiagongbao'
                }, function (ret, err) {
                    // alert(JSON.stringify(err))
                    if (!ret) {
                        toastMsg('未选择图片');
                        return
                    }
                    if (ret && ret.data.length > 0) {
                        app.uploadImg(ret.data)
                    }
                });
            },
            // 删除图片
            delImg: function (index) {
                app.postData.pic_url.splice(index, 1)
            },
            // 上传图片
            uploadImg: function (file) {
                api.showProgress({
                    title: '上传图片',
                    text: '正在上传图片...',
                    modal: true
                });
                ApiAjax('upload/uploadImage', {token: getToken()}, function (ret, err) {
                    if (ret.code == 1) {
                        // T = setInterval(function () {
                        //     app.uploadtime++;
                        //     if (app.uploadtime >= 15) {
                        //         toastMsg('上传超时，稍后再试');
                        //         api.hideProgress();
                        //         clearInterval(T)
                        //     }
                        // }, 1000);
                        api.hideProgress();
                        toastMsg('上传成功');
                        app.postData.pic_url.push(ret.data.path)
                    } else {
                        api.hideProgress();
                        toastMsg(ret.message)

                    }

                }, {file: file})
            },
            // 图片预览
            browserImg: function (index) {
                var imageBrowser = api.require('imageBrowser');
                for (var i in app.postData.pic_url) {
                    app.postData.pic_url[i] = imgUrl + app.postData.pic_url[i]
                }
                imageBrowser.openImages({
                    imageUrls: app.postData.pic_url,
                    showList: false,
                    activeIndex: index,
                });
            },
            // 发布订单
            relOrder: function () {
                if (app.postData.title == '') {
                    toastMsg('请输入标题');
                    return
                }
                if (!app.postData.province_code && !app.postData.city_code && !app.postData.region_code) {
                    toastMsg('请完善地区');
                    return
                }
                if (app.postData.cate_ids.length <= 0) {
                    toastMsg('至少选择一个分类');
                    return
                }
                if (app.postData.material == '') {
                    toastMsg('请填写材质');
                    return
                }
                if (app.postData.num <= 0) {
                    toastMsg('数量不能少于1');
                    return
                }
                if (app.postData.end_time == '') {
                    toastMsg('请选择订单失效时间');
                    return
                }
                if (app.postData.desc.length > 200) {
                    toastMsg('备注不能超过200字');
                    return
                }
                // if (app.postData.pic_url.length < 0) {
                //     toastMsg('至少上传一张相关图片');
                //     return
                // }
                if (app.postData.compname == '') {
                    toastMsg('请填写公司名称');
                    return
                }
                if (app.postData.linktel == '') {
                    toastMsg('请输入联系电话');
                } else if (!/^1\d{10}$/gi.test(app.postData.linktel)) {
                    toastMsg('联系电话不正确');
                    return
                }
                if (app.postData.linkman == '') {
                    toastMsg('请输入联系人姓名');
                    return
                }
                api.confirm({
                    title: '发布订单',
                    msg: '发布订单成功后，会进入审核状态，可在 个人中心->已发订单 查看审核状态',
                    buttons: ['取消', '确定']
                }, function (ret, err) {
                    var index = ret.buttonIndex;
                    if (index == 2) {
                        app.orderRelease()
                    }
                });
            },
            // 发布
            orderRelease: function () {
                api.showProgress({
                    title: '发布订单',
                    text: '发布中...',
                    modal: true
                });
                var post = {
                    token: getToken(),
                    title: app.postData.title,
                    province_code: app.postData.province_code,
                    city_code: app.postData.city_code,
                    region_code: app.postData.region_code,
                    cate_ids: app.postData.cate_ids,
                    material: app.postData.material,
                    num: app.postData.num,
                    unit:app.postData.unit?app.postData.unit:'件',
                    end_time: app.postData.end_time,
                    desc: app.postData.desc,
                    pic_url: app.postData.pic_url,
                    compname: app.postData.compname,
                    linktel: app.postData.linktel,
                    linkman: app.postData.linkman,
                };
                // //alert(JSON.stringify(post));
                $api.setStorage('postData', JSON.stringify(post));
                ApiAjax('order/orderRelease', post, function (ret, err) {
                    // //alert(JSON.stringify(ret))
                    api.hideProgress();
                    if (ret.code == 1) {
                        toastMsg('发布成功，等待审核…');
                        // api.openWin({
                        //     name: 'index_win',
                        //     url: '../common/index_win.html',
                        //     slidBackEnabled: false,
                        //     reload: true,
                        //     vScrollBarEnabled: false,
                        //     hScrollBarEnabled: false,
                        // });
                        setTimeout(function () {
                            // api.openWin({
                            //     name: 'index_win',
                            //     url: '../common/index_win.html',
                            //     slidBackEnabled: false,
                            //     reload: true,
                            //     vScrollBarEnabled: false,
                            //     hScrollBarEnabled: false,
                            // });
                            openView('my_outorder', 'my/my_outorder', '外发订单')
                        }, 1500)
                    } else {
                        toastMsg(ret.message)
                    }
                }, {}, true)
            },
            // 是否缓存
            // savedata() {
            //     $api.setStorage('postData', JSON.stringify(app.postData))
            // }
        },
        watch: {
            // 监听表单是否变化
            'postData': {
                handler: function (obj, objl) {
                    var postData = JSON.parse(JSON.stringify(app.postData));
                    for (var i in postData) {
                        if (obj[i] == postData[i]) {
                            // api.sendEvent({
                            //     name: 'saveData',
                            //     extra: {
                            //         savevalue: 1
                            //     }
                            // });
                        }
                    }
                },
                deep: true
            }
        }
    })
</script>
